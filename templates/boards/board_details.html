{% extends 'base.html' %}
{% load static %}
{% load permissions_tags %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/pages/_board.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
{% endblock %}

{% block body_class %}board-page{% endblock %}

{% block content %}
{% has_board_permission board "editor" as can_edit %}
{% board_permission_label board as permission_label %}

<div class="page-body">

  <!-- Sidebar -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="{% url 'dashboard' %}"><i class="fas fa-th-large"></i> Dashboard</a></li>
      <li><a href="{% url 'board_edit' username=board.created_by.username slug=board.slug %}"><i class="fas fa-cog"></i> Configurações</a></li>
    </ul>
  </aside>

  <!-- Navbar -->
  <div class="board-topbar">
    <div class="board-name">{{ board.name }}</div>
    <div class="permission-level">{{ permission_label }}</div>
    <div class="board-actions">
      <input type="text" placeholder="Pesquisar..." />
      {% if can_edit %}
        <button class="share-btn"><i class="fas fa-share-alt"></i> Compartilhar</button>
      {% endif %}
    </div>
  </div>

  <!-- Colunas -->
  <div class="board-columns-wrapper">
    <div class="board-columns">
      {% for column in columns %}
        <section class="column-card" data-column-id="{{ column.id }}">
          <header class="column-header" data-column-id="{{ column.id }}">
            <span class="column-name" tabindex="0" role="button" aria-label="Editar nome da coluna">{{ column.name }}</span>

            {% if can_edit %}
              <button class="column-options-btn" aria-label="Opções da coluna">
                <i class="fas fa-ellipsis-h"></i>
              </button>

              <div class="column-options-dropdown" style="display:none;">
                <button class="move-column-btn" disabled>Mover coluna</button>
                <button class="delete-column-btn"
                        data-column-id="{{ column.id }}"
                        data-delete-url="{% url 'column_delete_ajax' username=board.created_by.username slug=board.slug pk=column.id %}">
                  Excluir
                </button>
              </div>
            {% endif %}
          </header>

          <div class="tasks-container"></div>

          {% if can_edit %}
            <button class="add-task-btn">+ Adicionar tarefa</button>
          {% endif %}
        </section>
      {% endfor %}

      {% if can_edit %}
        <section class="column-card create-column">
          <button id="add-column-btn" class="btn btn-signup">
            <i class="fas fa-plus plus-icon"></i>
            <span>Adicionar coluna</span>
          </button>
        </section>
      {% endif %}
    </div>

    {% if can_edit %}
      <!-- Modal de adicionar coluna (fora da div board-columns para não quebrar layout) -->
      <div id="addColumnModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="add-column-title" tabindex="-1" hidden>
        <div class="modal-content">
          <button id="cancelAddColumn" class="modal-close-btn" aria-label="Fechar modal">&times;</button>
          <h3 id="add-column-title">Adicionar nova coluna</h3>
          <form id="addColumnForm" novalidate>
            <input type="text" name="name" placeholder="Nome da coluna" required maxlength="100" aria-label="Nome da coluna" class="input-field" />
            <div class="modal-buttons" style="margin-top: 16px;">
              <button type="submit" class="btn btn-login" style="width: 100%;">Criar</button>
            </div>
          </form>
        </div>
      </div>
    {% endif %}
  </div>

</div>

{% if can_edit %}
  <!-- Modal de exclusão da coluna -->
  <div id="deleteColumnModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Excluir coluna</h3>
      <p>Tem certeza que deseja excluir esta coluna? Essa ação não pode ser desfeita.</p>
      <div class="modal-buttons">
        <button class="confirm-delete btn btn-danger">Excluir</button>
        <button class="cancel-delete btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  window.username = "{{ board.created_by.username }}";
  window.slug = "{{ board.slug }}";
</script>

<script src="{% static 'js/column_edit.js' %}"></script>
<script src="{% static 'js/add_column.js' %}"></script>
{% endblock %}
